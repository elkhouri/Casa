<% provide :title, @title %>
<script src='https://www.google.com/jsapi'></script>

<div class='page-header'>
  <h3> <%= @user.name %> 
  <span class="label label-primary"><%= @user.class %> </span></h3>
</div>

<ul class="nav nav-tabs nav-append-content" id='profile_tab'>
  <li class='active'><a href='#profile' data-toggle="tab">Profile / Perfile</a></li>
  <% case @user.class.to_s %>
    <% when "Student" %>
      <li><a href='#score_cards' data-toggle="tab">Score Cards / Boleta de Calificaciones </a></li>
      <li><a href='#authorized' data-toggle="tab">Authorized Adults / Padres</a></li>
      <li><a href='#attendance' data-toggle="tab">Attendance/ Asistencia</a></li>
      <li><a href='#stats' data-toggle="tab">Statistics / Estadística</a></li>
    <% when "Volunteer" %>
      <li><a href='#authorized' data-toggle="tab">Students / Estudiantes</a></li>
      <li><a href='#attendance' data-toggle="tab">Attendance / Asistencia</a></li>
      <li><a href='#stats' data-toggle="tab">Statistics / Estadística</a></li>
    <% when "Parent" %>
      <li><a href='#authorized' data-toggle="tab">Children / Hijos</a></li>
  <% end %>
</ul>

<div class="tab-content">
  <div class="tab-pane fade in active" id="profile">
    <% if not @user.grade.nil? %> 
    <div class='row'>
    <div class='col-xs-2'>Grade / Grado: </div>
    <div class='col-xs-10'> <%= @user.grade %> </div> 
    </div> <% end %>

    <div class='row'>
    <div class='col-xs-2'>ID: </div>
    <div class='col-xs-10'><%= @user.ID_num %></div>
    </div>

    <div class='row'>
    <div class='col-xs-2'>Address / Direción: </div>
    <div class='col-xs-10'><%= @user.address %></div>
    </div>

    <div class='row'>
    <div class='col-xs-2'>Phone / Teléfono: </div>
    <div class='col-xs-10'><%= @user.phone %></div>
    </div>

    <div class='row'>
    <div class='col-xs-2'>Email / Correo Electrónico: </div>
    <div class='col-xs-10'><%= @user.email %></div>
    </div>

    <% if not @user.session.nil? %> <div class='row'>
    <div class='col-xs-2'>Session / Sesión: </div>
    <div class='col-xs-10'><%= @user.session %></div>
    </div> <% end %>

    <% if not @user.specialization.nil? %> <div class='row'>
    <div class='col-xs-2'>Specialization / Especialización: </div>
    <div class='col-xs-10'><%= @user.specialization %></div>
    </div> <% end %>

    <% if not @user.interest.nil? %> <div class='row'>
    <div class='col-xs-2'>Interests / Intereses: </div>
    <div class='col-xs-10'><%= @user.interest %></div>
    </div> <% end %>

    <% if not @user.note.nil? %> <div class='row'>
    <div class='col-xs-2'>Notes / Notas: </div>
    <div class='col-xs-10'><%= @user.note %></div>
    </div> <% end %>
    <%= link_to "Edit", edit_user_path , class:'btn btn-warning'%>
  </div>
  
  <div class="tab-pane fade" id="score_cards">
    <div class="panel-group" id="accordion">
      <% if current_user.is_a?(Volunteer) %>
        <%= render partial:'score_cards/score_card_form' ,collection: current_user.students, as: :student %>
        <%= will_paginate current_user.students.paginate(page: params[:page])%>
      <% elsif @user.is_a?(Student) %>
        <%= render @user.score_cards%>
        <%= will_paginate @user.score_cards.paginate(page: params[:page])%>
      <% end %>
    </div>
  </div>
  
  <div class="tab-pane fade" id="attendance">
    <div id='calendar'></div>
  </div>
  
  <div class="tab-pane fade" id="authorized">
    <% if @user.is_a?(Parent) %>
      <% users = @user.children %>
    <% elsif @user.is_a?(Student) %>
      <% users = @user.parents %>
    <% elsif @user.is_a?(Volunteer) %>
      <% users = @user.students %>
    <% end %>
    <div class="list-group">
      <%= render partial:'user_list', collection: users, as: :user %>
    </div>
  </div>
  
  <div class="tab-pane fade" id="stats">
    <% if @user.is_a?(Student) or @user.is_a?(Volunteer) %>
      <div class='chart' id='attendance_chart'></div>
      <%= render_chart(@attendance_chart, 'attendance_chart') %>
    <% end %>
    <% if @user.is_a?(Student) %>
      <div class='row'>
        <div class='col-md-4'><div class='chart' id='subject_pie'></div></div>
        <div class='col-md-4'><div class='chart' id='dropoff_pie'></div></div>
        <div class='col-md-4'><div class='chart' id='pickup_pie'></div></div>
        
        <%= render_chart(@subject_pie, 'subject_pie') %>
        <%= render_chart(@dropoff_pie, 'dropoff_pie') %>
        <%= render_chart(@pickup_pie, 'pickup_pie') %>
      </div>
    <% end %>
  </div>
</div>

<script>
$(document).ready(function () {
  flag = false

  $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
    if(!flag){
      $('#calendar').fullCalendar({
        header: {
            left: 'prev,next today',
            center: 'title'
        },
        aspectRatio: 2,
        events: [
            <% @attendances.each_with_index do |a, i|%>
              {
                <% if @user.is_a?(Student) %>
                  title: "<%= "Attended and brought work: " << Subject.find(a.subject).name %>",
                <% elsif @user.is_a?(Volunteer) %>
                  title: "Attended",
                <% end %>
                start: new Date("<%= a.dropoff_time %>")
              }<%= i == @attendances.size-1?'':',' %>
            <% end %>
        ]
      });
      flag = true
    }
  })
  
})
</script>
